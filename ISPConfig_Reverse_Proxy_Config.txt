# ISPConfig Reverse Proxy Configuration
# Add this to your site's Apache Directives or Nginx Directives in ISPConfig

# ============================================
# APACHE CONFIGURATION (if using Apache)
# ============================================

# Add this in ISPConfig: Sites → Your Domain → Options → Apache Directives

# Proxy API requests to backend via Cloudflare Tunnel
# Replace https://api.your-domain.com with your actual Cloudflare Tunnel URL
ProxyPreserveHost On
ProxyPass /routes/ https://api.your-domain.com/routes/
ProxyPassReverse /routes/ https://api.your-domain.com/routes/

# Serve frontend static files
DocumentRoot /var/www/your-domain.com/versicherung-x/frontend/dist

<Directory /var/www/your-domain.com/versicherung-x/frontend/dist>
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted
    
    # Handle React Router (SPA routing)
    RewriteEngine On
    RewriteBase /
    RewriteRule ^index\.html$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.html [L]
</Directory>

# Don't proxy static assets
ProxyPass /routes !
ProxyPass /assets !
ProxyPass /favicon.ico !

# Enable proxy modules (if not already enabled)
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule rewrite_module modules/mod_rewrite.so

# ============================================
# NGINX CONFIGURATION (if using Nginx)
# ============================================

# Add this in ISPConfig: Sites → Your Domain → Options → Nginx Directives
# Just paste the location blocks below - ISPConfig handles the server block

# Proxy API requests to backend via Cloudflare Tunnel
# Replace https://api.your-domain.com with your actual Cloudflare Tunnel URL
# This passes /routes/* requests to the Cloudflare Tunnel (which forwards to backend VM)
location /routes/ {
    proxy_pass https://api.your-domain.com;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass_header Authorization;
    client_max_body_size 0;
    client_body_buffer_size 1m;
    proxy_intercept_errors on;
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 256 16k;
    proxy_busy_buffers_size 256k;
    proxy_temp_file_write_size 256k;
    proxy_max_temp_file_size 0;
    proxy_read_timeout 600;
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
}

# Handle React Router (SPA) - serve index.html for non-API routes
# This ensures client-side routing works
location / {
    try_files $uri $uri/ /index.html;
}

# ============================================
# IMPORTANT NOTES
# ============================================

# 1. Replace "your-domain.com" with your actual domain path
# 2. Ensure mod_proxy and mod_rewrite are enabled in Apache
# 3. For Nginx, ensure proxy_pass is available
# 4. Adjust paths according to your actual server setup
# 5. The backend runs on a separate Linux VM, exposed via Cloudflare Tunnel
# 6. Replace "https://api.your-domain.com" with your actual Cloudflare Tunnel URL
# 7. Frontend static files are served from /frontend/dist after running `yarn build`

# ============================================
# ISPConfig SPECIFIC INSTRUCTIONS
# ============================================

# In ISPConfig Web Interface:
# 1. Go to: Sites → Select your domain
# 2. Click on "Options" tab
# 3. Scroll to "Apache Directives" or "Nginx Directives"
# 4. Paste the appropriate configuration above
# 5. Replace "/var/www/your-domain.com" with your actual path
# 6. Click "Save"
# 7. ISPConfig will regenerate the configuration files
# 8. Restart Apache/Nginx: sudo systemctl restart apache2 (or nginx)

